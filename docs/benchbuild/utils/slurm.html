<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.8.1" />
<title>benchbuild.utils.slurm API documentation</title>
<meta name="description" content="SLURM support for the benchbuild study â€¦" />
<link href='https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.0/normalize.min.css' rel='stylesheet'>
<link href='https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/8.0.0/sanitize.min.css' rel='stylesheet'>
<link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" rel="stylesheet">
<style>.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>benchbuild.utils.slurm</code></h1>
</header>
<section id="section-intro">
<p>SLURM support for the benchbuild study.</p>
<p>This module can be used to generate bash scripts that can be executed by
the SLURM controller either as batch or interactive script.</p>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">&#34;&#34;&#34;
SLURM support for the benchbuild study.

This module can be used to generate bash scripts that can be executed by
the SLURM controller either as batch or interactive script.
&#34;&#34;&#34;
import logging
import os
import sys
from typing import Iterable
from pathlib import Path

from plumbum import local, TF

from benchbuild.settings import CFG
from benchbuild.experiment import Experiment
from benchbuild.utils.cmd import bash, chmod
from benchbuild.utils.path import list_to_path

LOG = logging.getLogger(__name__)


def script(experiment):
    &#34;&#34;&#34;
    Prepare a slurm script that executes the experiment for a given project.

    Args:
        experiment: The experiment we want to execute
        projects: All projects we generate an array job for.
    &#34;&#34;&#34;
    projects = __expand_project_versions__(experiment)
    benchbuild_c = local[local.path(sys.argv[0])]
    slurm_script = local.cwd / experiment.name + &#34;-&#34; + str(
        CFG[&#39;slurm&#39;][&#39;script&#39;])

    srun = local[&#34;srun&#34;]
    srun_args = []
    if not CFG[&#34;slurm&#34;][&#34;multithread&#34;]:
        srun_args.append(&#34;--hint=nomultithread&#34;)
    if not CFG[&#34;slurm&#34;][&#34;turbo&#34;]:
        srun_args.append(&#34;--pstate-turbo=off&#34;)

    srun = srun[srun_args]
    srun = srun[benchbuild_c[&#34;run&#34;]]

    return __save__(slurm_script, srun, experiment, projects)


def __expand_project_versions__(experiment: Experiment) -&gt; Iterable[str]:
    project_types = experiment.projects
    expanded = []

    for _, project_type in project_types.items():
        for version in experiment.sample(project_type, project_type.versions()):
            project = project_type(experiment, version=version)
            expanded.append(&#34;{name}-{group}@{version}&#34;.format(
                name=project.name,
                group=project.group,
                version=project.version))
    return expanded


def __path():
    host_path = os.getenv(&#39;PATH&#39;, default=&#39;&#39;)
    env = CFG[&#39;env&#39;].value
    benchbuild_path = list_to_path(env.get(&#39;PATH&#39;, []))
    return os.path.pathsep.join([benchbuild_path, host_path])


def __ld_library_path():
    host_path = os.getenv(&#39;LD_LIBRARY_PATH&#39;, default=&#39;&#39;)
    env = CFG[&#39;env&#39;].value
    benchbuild_path = list_to_path(env.get(&#39;LD_LIBRARY_PATH&#39;, []))
    return os.path.pathsep.join([benchbuild_path, host_path])


def __save__(script_name, benchbuild, experiment, projects):
    &#34;&#34;&#34;
    Dump a bash script that can be given to SLURM.

    Args:
        script_name (str): name of the bash script.
        commands (list(benchbuild.utils.cmd)):
            List of plumbum commands to write to the bash script.
        **kwargs: Dictionary with all environment variable bindings we should
            map in the bash script.
    &#34;&#34;&#34;
    from jinja2 import Environment, PackageLoader

    logs_dir = Path(CFG[&#39;slurm&#39;][&#39;logs&#39;].value)
    if logs_dir.suffix != &#39;&#39;:
        logs_dir = logs_dir.parent / logs_dir.stem
        LOG.warning(
            f&#34;Config slurm:logs should be a folder, defaulting to {logs_dir}.&#34;)

    if not logs_dir.exists():
        logs_dir.mkdir()

    node_command = str(benchbuild[&#34;-E&#34;, experiment.name, &#34;$_project&#34;])
    env = Environment(
        trim_blocks=True,
        lstrip_blocks=True,
        loader=PackageLoader(&#39;benchbuild&#39;, &#39;utils/templates&#39;))
    template = env.get_template(&#39;slurm.sh.inc&#39;)

    with open(script_name, &#39;w&#39;) as slurm2:
        slurm2.write(
            template.render(
                config=[&#34;export &#34; + x for x in repr(CFG).split(&#39;\n&#39;)],
                clean_lockdir=str(CFG[&#34;slurm&#34;][&#34;node_dir&#34;]),
                clean_lockfile=str(CFG[&#34;slurm&#34;][&#34;node_dir&#34;]) + \
                    &#34;.clean-in-progress.lock&#34;,
                cpus=int(CFG[&#39;slurm&#39;][&#39;cpus_per_task&#39;]),
                exclusive=bool(CFG[&#39;slurm&#39;][&#39;exclusive&#39;]),
                lockfile=str(CFG[&#39;slurm&#39;][&#34;node_dir&#34;]) + &#34;.lock&#34;,
                log=logs_dir.resolve() / str(experiment.id),
                max_running=int(CFG[&#39;slurm&#39;][&#39;max_running&#39;]),
                name=experiment.name,
                nice=int(CFG[&#39;slurm&#39;][&#39;nice&#39;]),
                nice_clean=int(CFG[&#34;slurm&#34;][&#34;nice_clean&#34;]),
                node_command=node_command,
                no_multithreading=not CFG[&#39;slurm&#39;][&#39;multithread&#39;],
                ntasks=1,
                prefix=str(CFG[&#34;slurm&#34;][&#34;node_dir&#34;]),
                projects=projects,
                slurm_account=str(CFG[&#34;slurm&#34;][&#34;account&#34;]),
                slurm_partition=str(CFG[&#34;slurm&#34;][&#34;partition&#34;]),
                timelimit=str(CFG[&#39;slurm&#39;][&#39;timelimit&#39;]),
            )
        )

    chmod(&#34;+x&#34;, script_name)
    if not __verify__(script_name):
        LOG.error(&#34;SLURM script failed verification.&#34;)
    print(&#34;SLURM script written to {0}&#34;.format(script_name))
    return script_name


def __verify__(script_name):
    &#34;&#34;&#34;
    Verify a generated script.

    Args:
        script_name: Path to the generated script.
    &#34;&#34;&#34;
    return (bash[&#34;-n&#34;, script_name] &amp; TF)</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-functions">Functions</h2>
<dl>
<dt id="benchbuild.utils.slurm.script"><code class="name flex">
<span>def <span class="ident">script</span></span>(<span>experiment)</span>
</code></dt>
<dd>
<div class="desc"><p>Prepare a slurm script that executes the experiment for a given project.</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>experiment</code></strong></dt>
<dd>The experiment we want to execute</dd>
<dt><strong><code>projects</code></strong></dt>
<dd>All projects we generate an array job for.</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def script(experiment):
    &#34;&#34;&#34;
    Prepare a slurm script that executes the experiment for a given project.

    Args:
        experiment: The experiment we want to execute
        projects: All projects we generate an array job for.
    &#34;&#34;&#34;
    projects = __expand_project_versions__(experiment)
    benchbuild_c = local[local.path(sys.argv[0])]
    slurm_script = local.cwd / experiment.name + &#34;-&#34; + str(
        CFG[&#39;slurm&#39;][&#39;script&#39;])

    srun = local[&#34;srun&#34;]
    srun_args = []
    if not CFG[&#34;slurm&#34;][&#34;multithread&#34;]:
        srun_args.append(&#34;--hint=nomultithread&#34;)
    if not CFG[&#34;slurm&#34;][&#34;turbo&#34;]:
        srun_args.append(&#34;--pstate-turbo=off&#34;)

    srun = srun[srun_args]
    srun = srun[benchbuild_c[&#34;run&#34;]]

    return __save__(slurm_script, srun, experiment, projects)</code></pre>
</details>
</dd>
</dl>
</section>
<section>
</section>
</article>
<nav id="sidebar">
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="benchbuild.utils" href="index.html">benchbuild.utils</a></code></li>
</ul>
</li>
<li><h3><a href="#header-functions">Functions</a></h3>
<ul class="">
<li><code><a title="benchbuild.utils.slurm.script" href="#benchbuild.utils.slurm.script">script</a></code></li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc"><cite>pdoc</cite> 0.8.1</a>.</p>
</footer>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad()</script>
</body>
</html>